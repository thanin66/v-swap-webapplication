{% extends "base.html" %}

{% block title %}Chat with {{ other_user.username }}{% endblock %}

{% block content %}

<style>
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
</style>

<div class="max-w-6xl mx-auto mt-6 p-4 h-[85vh]"> 
    
    <div class="bg-white rounded-xl shadow-lg overflow-hidden grid grid-cols-1 md:grid-cols-3 h-full border border-gray-200">
        
        <div class="hidden md:flex flex-col border-r border-gray-200 bg-white h-full overflow-hidden">
            
            <div class="flex-none p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50 h-[72px]">
                <h2 class="font-bold text-lg text-gray-800">Messages</h2>
                <a href="{% url 'home' %}" class="text-xs text-blue-600 font-semibold hover:underline">Home</a>
            </div>

            <div id="sidebar-container" class="flex-1 overflow-y-auto custom-scrollbar min-h-0">
                {% include "chat/chat_list.html" %}
            </div>
        </div>

        <div class="col-span-2 flex flex-col h-full bg-gray-50 relative overflow-hidden">
            
            <div class="flex-none bg-white p-4 flex items-center justify-between shadow-sm z-10 border-b border-gray-200 h-[72px]">
                <div class="flex items-center gap-3">
                    <a href="{% url 'home' %}" class="md:hidden text-gray-500 mr-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </a>

                    <div style="width: 40px; height: 40px;" class="relative flex-shrink-0 rounded-full bg-gray-200 overflow-hidden">
                        {% if other_user.userprofile.profile_picture %}
                            <img src="{{ other_user.userprofile.profile_picture.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ other_user.username }}&background=random" style="width: 100%; height: 100%; object-fit: cover;">
                        {% endif %}
                    </div>
                    <div>
                        <h2 class="text-lg font-bold leading-tight text-gray-800">{{ other_user.username }}</h2>
                        <span class="text-xs text-green-500 flex items-center gap-1 font-medium">
                            Active Now
                        </span>
                    </div>
                </div>
            </div>

            <div id="chat-log" class="flex-1 p-4 overflow-y-auto min-h-0 space-y-4 bg-gray-50 custom-scrollbar">
                {% for msg in messages %}
                <div class="flex items-end gap-2 {% if msg.sender == request.user %}justify-end{% else %}justify-start{% endif %}">
                    
                    {% if msg.sender != request.user %}
                        <div style="width: 30px; height: 30px;" class="flex-shrink-0 rounded-full overflow-hidden shadow-sm mb-1 bg-gray-200">
                            {% if other_user.userprofile.profile_picture %}
                                <img src="{{ other_user.userprofile.profile_picture.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ other_user.username }}&background=random" style="width: 100%; height: 100%; object-fit: cover;">
                            {% endif %}
                        </div>
                    {% endif %}

                    <div class="max-w-[70%] px-4 py-2 shadow-sm text-sm
                        {% if msg.sender == request.user %}
                            bg-blue-600 text-white rounded-2xl rounded-br-none
                        {% else %}
                            bg-white text-gray-800 border border-gray-200 rounded-2xl rounded-bl-none
                        {% endif %}">
                        <p class="leading-relaxed break-words">{{ msg.content }}</p>
                        <p class="text-[10px] mt-1 opacity-70 text-right">{{ msg.timestamp|date:"H:i" }}</p>
                    </div>

                    {% if msg.sender == request.user %}
                        <div style="width: 30px; height: 30px;" class="flex-shrink-0 rounded-full overflow-hidden shadow-sm mb-1 bg-gray-200">
                            {% if request.user.userprofile.profile_picture %}
                                <img src="{{ request.user.userprofile.profile_picture.url }}" style="width: 100%; height: 100%; object-fit: cover;">
                            {% else %}
                                <img src="https://ui-avatars.com/api/?name={{ request.user.username }}&background=0D8ABC&color=fff" style="width: 100%; height: 100%; object-fit: cover;">
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>

            <div class="flex-none p-3 bg-white border-t border-gray-200 z-20">
                <form id="chat-form" class="flex gap-2 items-center">
                    <input type="text" id="chat-message-input" 
                           class="flex-1 bg-gray-100 text-gray-800 border-0 rounded-full px-5 py-3 focus:outline-none focus:ring-1 focus:ring-blue-500 transition placeholder-gray-500"
                           placeholder="Type a message..." autocomplete="off">
                    
                    <button type="submit" class="text-blue-600 hover:text-blue-700 p-2 transition hover:bg-blue-50 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
                          <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{{ request.user.id|json_script:"user_id" }}

<script>
    const myId = JSON.parse(document.getElementById('user_id').textContent);
    const otherUserId = "{{ other_user.id }}";
    
    // Config Avatar URLs
    const myAvatarUrl = "{% if request.user.userprofile.profile_picture %}{{ request.user.userprofile.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={{ request.user.username }}&background=0D8ABC&color=fff{% endif %}";
    const otherAvatarUrl = "{% if other_user.userprofile.profile_picture %}{{ other_user.userprofile.profile_picture.url }}{% else %}https://ui-avatars.com/api/?name={{ other_user.username }}&background=random{% endif %}";

    const chatLog = document.querySelector('#chat-log');
    
    function scrollToBottom() {
        chatLog.scrollTop = chatLog.scrollHeight;
    }
    
    // Auto Scroll on Load
    scrollToBottom();
    setTimeout(scrollToBottom, 100);

    // WebSocket Connection
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/chat/' + otherUserId + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const message = data.message;
        const senderId = data.sender_id;
        const isMe = (senderId === myId);

        const now = new Date();
        const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

        const wrapper = document.createElement('div');
        wrapper.className = `flex items-end gap-2 mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;

        const currentAvatarUrl = isMe ? myAvatarUrl : otherAvatarUrl;

        const avatarHtml = `
            <div style="width: 30px; height: 30px;" class="flex-shrink-0 rounded-full overflow-hidden shadow-sm mb-1 bg-gray-200">
                <img src="${currentAvatarUrl}" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
        `;

        const messageHtml = `
            <div class="max-w-[70%] px-4 py-2 shadow-sm text-sm ${
                isMe ? 'bg-blue-600 text-white rounded-2xl rounded-br-none' : 'bg-white text-gray-800 border border-gray-200 rounded-2xl rounded-bl-none'
            }">
                <p class="leading-relaxed break-words">${message}</p>
                <p class="text-[10px] mt-1 opacity-70 text-right">${timeString}</p>
            </div>
        `;

        wrapper.innerHTML = isMe ? (messageHtml + avatarHtml) : (avatarHtml + messageHtml);
        chatLog.appendChild(wrapper);
        scrollToBottom();
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-form').onsubmit = function(e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;
        if(message.trim()) {
            chatSocket.send(JSON.stringify({'message': message}));
            messageInputDom.value = '';
        }
    };

    // ==========================================
    // ส่วนที่เพิ่มใหม่: อัปเดต Sidebar อัตโนมัติ
    // ==========================================
    function updateSidebar() {
        const container = document.getElementById('sidebar-container');
        // เรียก API ไปหลังบ้าน โดยส่ง ID ของคนที่เราคุยอยู่ไปด้วย เพื่อให้ไฮไลท์สีฟ้าถูกคน
        fetch(`/chat/sidebar-api/${otherUserId}/`)
            .then(response => {
                if (!response.ok) throw new Error("Network response was not ok");
                return response.text();
            })
            .then(html => {
                // เอา HTML ใหม่ยัดใส่เข้าไปแทนที่ของเดิม
                container.innerHTML = html;
            })
            .catch(err => console.error('Sidebar update error:', err));
    }

    // สั่งให้ทำงานทุกๆ 3 วินาที (3000 ms)
    setInterval(updateSidebar, 3000);

</script>
{% endblock %}