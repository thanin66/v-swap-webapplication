{% extends "base.html" %}

{% block title %}‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏°‡∏û{% endblock %}

{% block content %}

<div x-data="twoWayPosition({{ req.id }})" x-init="start()" class="max-w-2xl mx-auto p-4">
    <h2 class="text-xl font-bold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</h2>

    <div id="map" class="h-96 rounded border"></div>

    <div class="mt-4 flex flex-col space-y-2">
        <div class="flex space-x-2">
            <button 
                @click="submitPosition()" 
                :disabled="myConfirmed && !markerMoved"
                class="bg-blue-600 text-white px-4 py-2 rounded flex-1"
            >
                <span x-show="!myConfirmed">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
                <span x-show="myConfirmed && !markerMoved">‚úî ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                <span x-show="myConfirmed && markerMoved">üí° ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
            </button>

            <button 
                @click="resetMarker()" 
                x-show="myConfirmed && markerMoved" 
                class="bg-gray-400 text-white px-4 py-2 rounded flex-1"
            >
                üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
            </button>
        </div>

        <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢ -->
        <p class="text-gray-700">
            ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ 1: <span x-text="user1Text"></span><br>
            ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ 2: <span x-text="user2Text"></span>
        </p>

        <p class="text-green-600" x-show="done">
            ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‚úÖ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
        </p>
    </div>

    <button 
        x-show="done"
        class="mt-4 bg-green-600 text-white px-4 py-2 rounded w-full"
        @click="goNext()"
    >
        ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠
    </button>
</div>

<script>
function twoWayPosition(requestId) {
    return {
        myConfirmed: false,
        otherConfirmed: false,
        lat: null,
        lng: null,
        markerMyself: null,
        markerOther: null,
        confirmedLat: null,
        confirmedLng: null,
        markerMoved: false,
        done: false,
        map: null,
        interval: null,

        user1Text: "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        user2Text: "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",

        medalMyself: null,
        medalOther: null,

        start() {
            let defaultLat = {{ req.post.leaflet_lat|default:"13.736717" }};
            let defaultLng = {{ req.post.leaflet_lng|default:"100.523186" }};

            this.map = L.map('map').setView([defaultLat, defaultLng], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);

            // Marker ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
            this.markerMyself = L.marker([defaultLat, defaultLng], {icon: this.getUserIcon()}).addTo(this.map);
            this.lat = defaultLat;
            this.lng = defaultLng;

            // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô map
            this.map.on('click', e => { 
                this.lat = e.latlng.lat;
                this.lng = e.latlng.lng;
                this.markerMyself.setLatLng([this.lat, this.lng]);
                if(this.myConfirmed) this.markerMoved = true;
            });

            this.fetchStatus();
            this.interval = setInterval(() => this.fetchStatus(), 2000);
        },

        getUserIcon() {
            return L.icon({
                iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                shadowSize: [41, 41]
            });
        },

        getOtherIcon() {
            return L.icon({
                iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                shadowSize: [41, 41]
            });
        },

        getMedalIcon() {
            return L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/2583/2583349.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });
        },

        async fetchStatus() {
            const res = await fetch(`/requests/api/map/status/${requestId}/`);
            const data = await res.json();

            if (data.lat && data.lng && (data.lat !== this.confirmedLat || data.lng !== this.confirmedLng)) {
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏£‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Server
                    this.confirmedLat = data.lat;
                    this.confirmedLng = data.lng;
                    // ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏°‡πà
                    this.markerMyself.setLatLng([data.lat, data.lng]); 
                    this.map.setView([data.lat, data.lng]);
                    alert("‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏û‡∏ö!");
                }
                
            this.myConfirmed = data.my_confirmed;
            this.otherConfirmed = data.other_confirmed;
            this.done = this.myConfirmed && this.otherConfirmed;

            this.user1Text = data.my_confirmed ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
            this.user2Text = data.other_confirmed ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";

            // Marker ‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢
            if(data.other_lat && data.other_lng){
                if(!this.markerOther){
                    this.markerOther = L.marker([data.other_lat, data.other_lng], {icon: this.getOtherIcon()}).addTo(this.map);
                } else {
                    this.markerOther.setLatLng([data.other_lat, data.other_lng]);
                }
            }

            // Marker ‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏¢‡πâ‡∏≤‡∏¢
            if(!this.markerMoved && data.lat && data.lng){
                this.markerMyself.setLatLng([data.lat, data.lng]);
                this.map.setView([data.lat, data.lng], this.map.getZoom());
                if(this.myConfirmed){
                    this.confirmedLat = data.lat;
                    this.confirmedLng = data.lng;
                }
            }

            // Medal ‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á
            if(this.done){
                if(this.markerMyself && !this.medalMyself){
                    this.medalMyself = L.marker([this.lat, this.lng], {icon: this.getMedalIcon()}).addTo(this.map);
                }
                if(this.markerOther && !this.medalOther){
                    this.medalOther = L.marker([this.markerOther.getLatLng().lat, this.markerOther.getLatLng().lng], {icon: this.getMedalIcon()}).addTo(this.map);
                }
            }
        },

        async submitPosition() {
            if(!this.lat || !this.lng) return alert("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏°‡∏û‡∏Å‡πà‡∏≠‡∏ô");
            const res = await fetch(`/requests/api/map/submit/${requestId}/`, {
                method: "POST",
                headers: {"X-CSRFToken": "{{ csrf_token }}"},
                body: new URLSearchParams({lat: this.lat, lng: this.lng})
            });
            const data = await res.json();
            if(data.reset) alert("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢!");
            this.markerMoved = false;
            this.confirmedLat = this.lat;
            this.confirmedLng = this.lng;
            this.fetchStatus();
        },

        resetMarker() {
            if(this.confirmedLat && this.confirmedLng){
                this.lat = this.confirmedLat;
                this.lng = this.confirmedLng;
                this.markerMyself.setLatLng([this.lat, this.lng]);
                this.map.setView([this.lat, this.lng], this.map.getZoom());
                this.markerMoved = false;
            }
        },

        goNext() {
            if(this.done) window.location.href = `/requests/next-step/${requestId}/`;
        }
    }
}
</script>

{% endblock %}