{% extends "base.html" %}

{% block title %}‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏°‡∏û{% endblock %}

{% block content %}

<div x-data="twoWayPosition({{ req.id }})" x-init="start()" class="max-w-2xl mx-auto p-4">
    <h2 class="text-xl font-bold mb-4">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏Å‡∏Ç‡∏≠‡∏á</h2>

    <div id="map" class="h-96 w-full rounded-lg border shadow-md z-0"></div>

    <div class="mt-4 flex flex-col space-y-4">
        <div class="flex space-x-2">
            <button 
                @click="submitPosition()" 
                :disabled="myConfirmed && !markerMoved"
                class="px-4 py-2 rounded flex-1 font-medium transition duration-200"
                :class="(myConfirmed && !markerMoved) ? 'bg-green-100 text-green-700 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'"
            >
                <span x-show="!myConfirmed">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ô‡∏µ‡πâ</span>
                <span x-show="myConfirmed && !markerMoved">‚úî ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
                <span x-show="myConfirmed && markerMoved">üí° ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</span>
            </button>

            <button 
                @click="resetMarker()" 
                x-show="myConfirmed && markerMoved" 
                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded shadow transition"
            >
                üîÑ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢
            </button>
        </div>

        <div class="bg-gray-50 p-3 rounded-lg border text-sm text-gray-700 space-y-1">
            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏£‡∏≤:</strong> <span x-text="user1Text" :class="myConfirmed ? 'text-green-600 font-bold' : 'text-yellow-600'"></span></p>
            <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ù‡πà‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°:</strong> <span x-text="user2Text" :class="otherConfirmed ? 'text-green-600 font-bold' : 'text-yellow-600'"></span></p>
        </div>

        <div x-show="done" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</strong>
            <span class="block sm:inline"> ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
        </div>
    </div>

    <div class="mt-6 space-y-3">
        <button 
            x-show="done"
            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition transform hover:scale-105"
            @click="goNext()"
        >
            ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ ‚ûú
        </button>

        <a href="{% url 'chat_home' %}" class="block text-center w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition">
            < ‡∏Å‡∏•‡∏±‡∏ö
        </a>
    </div>

</div>

<script>
function twoWayPosition(requestId) {
    return {
        myConfirmed: false,
        otherConfirmed: false,
        lat: null,
        lng: null,
        
        // Marker references
        markerMyself: null,
        markerOther: null,
        
        // Status tracking
        confirmedLat: null,
        confirmedLng: null,
        markerMoved: false,
        done: false,
        
        map: null,
        interval: null,

        user1Text: "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
        user2Text: "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",

        medalMyself: null,
        medalOther: null,

        start() {
            // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ Default ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Backend
            let defaultLat = {{ req.position_lat|default:"13.7563" }};
            let defaultLng = {{ req.position_lng|default:"100.5018" }};

            this.map = L.map('map').setView([defaultLat, defaultLng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(this.map);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Marker ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤
            this.markerMyself = L.marker([defaultLat, defaultLng], {
                draggable: true, // ‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
                icon: this.getUserIcon()
            }).addTo(this.map);

            this.lat = defaultLat;
            this.lng = defaultLng;

            // Event: ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏•‡∏≤‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏ö
            this.markerMyself.on('dragend', (e) => {
                let position = this.markerMyself.getLatLng();
                this.lat = position.lat;
                this.lng = position.lng;
                if(this.myConfirmed) this.markerMoved = true;
            });

            // Event: ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î
            this.map.on('click', e => { 
                this.lat = e.latlng.lat;
                this.lng = e.latlng.lng;
                this.markerMyself.setLatLng([this.lat, this.lng]);
                if(this.myConfirmed) this.markerMoved = true;
            });

            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            this.fetchStatus();
            this.interval = setInterval(() => this.fetchStatus(), 3000); // Polling ‡∏ó‡∏∏‡∏Å 3 ‡∏ß‡∏¥
        },

        getUserIcon() {
            return L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        },

        getOtherIcon() {
            return L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        },

        getMedalIcon() {
            return L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/179/179249.png', // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            });
        },

        async fetchStatus() {
            // ‡∏ñ‡πâ‡∏≤‡∏à‡∏ö process ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á fetch ‡∏ï‡πà‡∏≠ (Optional)
            // if (this.done) return; 

            try {
                const res = await fetch(`/requests/api/map/status/${requestId}/`);
                const data = await res.json();

                // Logic: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (data.lat && data.lng && (data.lat !== this.confirmedLat || data.lng !== this.confirmedLng)) {
                     // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• lat/lng ‡∏à‡∏£‡∏¥‡∏á‡πÜ
                     this.confirmedLat = data.lat;
                     this.confirmedLng = data.lng;
                     
                     // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏£‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏û‡∏ö‡∏ó‡∏µ‡πà Server ‡∏ö‡∏≠‡∏Å
                     if (!this.markerMoved) {
                        this.markerMyself.setLatLng([data.lat, data.lng]);
                        this.lat = data.lat;
                        this.lng = data.lng;
                     }
                }
                
                this.myConfirmed = data.my_confirmed;
                this.otherConfirmed = data.other_confirmed;
                this.done = this.myConfirmed && this.otherConfirmed;

                this.user1Text = data.my_confirmed ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";
                this.user2Text = data.other_confirmed ? "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß" : "‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô";

                // Update Marker ‡∏ù‡∏±‡πà‡∏á‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                // ‡∏™‡∏°‡∏°‡∏ï‡∏¥ API ‡∏™‡πà‡∏á other_lat/lng ‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡∏•‡∏∞‡∏à‡∏∏‡∏î (‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏≠‡∏õ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡∏î‡∏π‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå)
                // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠ "‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏û‡∏ö‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô" ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ data.lat/lng ‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡∏Å‡∏•‡∏≤‡∏á
                
                // ‡∏Å‡∏£‡∏ì‡∏µ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ù‡πà‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤ API ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
                if(data.other_lat && data.other_lng){
                    if(!this.markerOther){
                        this.markerOther = L.marker([data.other_lat, data.other_lng], {icon: this.getOtherIcon()}).addTo(this.map);
                    } else {
                        this.markerOther.setLatLng([data.other_lat, data.other_lng]);
                    }
                }

            } catch (error) {
                console.error("Error fetching status:", error);
            }
        },

        async submitPosition() {
            if(!this.lat || !this.lng) return alert("‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÅ‡∏°‡∏û‡∏Å‡πà‡∏≠‡∏ô");
            
            try {
                const res = await fetch(`/requests/api/map/submit/${requestId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/x-www-form-urlencoded"
                    },
                    body: new URLSearchParams({lat: this.lat, lng: this.lng})
                });
                const data = await res.json();
                
                if(data.reset) {
                    alert("‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                }
                
                this.markerMoved = false;
                this.confirmedLat = this.lat;
                this.confirmedLng = this.lng;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å fetch ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                this.fetchStatus();
                
            } catch (error) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
            }
        },

        resetMarker() {
            if(this.confirmedLat && this.confirmedLng){
                this.lat = this.confirmedLat;
                this.lng = this.confirmedLng;
                this.markerMyself.setLatLng([this.lat, this.lng]);
                this.map.setView([this.lat, this.lng], this.map.getZoom());
                this.markerMoved = false;
            }
        },

        goNext() {
            if(this.done) window.location.href = `/requests/next-step/${requestId}/`;
        }
    }
}
</script>

{% endblock %}